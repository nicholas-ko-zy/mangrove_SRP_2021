---
title: "Mangrove Exploration -- Heat Map"
author: Nicholas Ko
output: 
 html_document:
    toc : TRUE
    toc_float: TRUE
    number_sections: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

NOTE: USE `set.seed(5)` for all random processes.

# Background 

This Rmd file does two things. 

1. Create simulated population based on different probabilities (the probability of the tree being there) \n See individual simulation sections (1/2/3) on how those probabilites are calculated and why. 

2. Plot Heat map to represent dissimilarity in species population between plots. Compare simulated versus observed dissimilarity. 

Further explanation is given at the start of each simulation section.

**load libraries**

```{r}
library(dplyr)
library(vegan)
library(tidyverse)
library(moderndive)
library(ggpmisc)
library(ggrepel)
library(ggpubr)
library(hrbrthemes)
library(heatmaply)
library(wesanderson)
library(usedist)
library(gridExtra)
library(gridBase)
library(png)
library(egg)
library(cowplot)
library(patchwork)
```


**load data**

```{r}
inventory <- read_csv("processed_data/inventory.csv")
tree_probs <- read_csv("processed_data/tree_probs_new.csv")

n_plots <- inventory %>%
  group_by(plot) %>%
  summarise(n_trees = n()) %>%
  ungroup()
```


# Dissimilarity 

Summary of work: In this section I will create three simulated populations of the observed trees. These three simulated populations will be generated by different set of probabilities. The aim is to compare **pairwise dissimilarity in species abundance** between the simulated plots with the observed plots 

The three probabilities are:

i.   Abundance And Elevation 
ii.  Abundance Per Plot
iii. Abundance Across All Plots

There are notes on how each of the probabilities are calculated at the start of each subsection. 


*Simulate pair-wise dissimilarity*

For each iteration, I will need to create: 

1. Species abundance matrix (change row and col names)

2. Run `vegdist()` on that matrix

3. Calculate difference between simulated matrix and observed data using the formula (observed - simulated)

4. Store this in a big data frame (1200 x 1200), since there are 12 unique plots

## Simulation 1 : Elevation & Abundance

For this simulation, I will use the `est_prob` column from the `tree_probs` data frame. (Can add more explanation of how `est_prob` is calculated)

**Elevation & abundance probability**

```{r demo data frames for explanation, include=FALSE}
set.seed(5)
demo_sp_abundance_sim <- as.data.frame(tree_probs %>%
  #remove low abundance and random species
  filter(!spp_orig %in% c("LURA","SCHY", "random")) %>%
  #code below tells R to generate 1 random species for every unique treeid, weighted by the column 'est_prob' which is the elevation x  abundance probability
  group_by(treeid) %>%
  sample_n(size = 1, weight = est_prob) %>%
  ungroup() %>% 
  #keep the following columns
  select(treeid, plot, spp_prob) %>%
  #code below counts the number of trees per species per plot per simulation
  group_by(plot, spp_prob) %>% 
  summarise(n_tree = n()) %>%
  #pivot to show species as columns and plot as rows
  pivot_wider(
  names_from = spp_prob, 
  values_from = n_tree,
  values_fill = 0
) %>%
  ungroup() %>%
  select(-plot))

demo_sim_dissim <- as.data.frame(as.matrix(vegdist(demo_sp_abundance_sim, method = "jaccard")))

rownames(demo_sp_abundance_sim) <- n_plots$plot

rownames(demo_sim_dissim) <- n_plots$plot
colnames(demo_sim_dissim) <- rownames(demo_sim_dissim)

```

Objects used in function:

`dissim_func` : Function I created to do the 4-step process listed above

1. `sp_abundance_sim` : Data frame created within `dissim_func`. It is a species abundance matrix where the columns are species and rows are plots. Each cell shows the count of trees per species per plot. 

```{r fig.width = 10, fig.height = 5, echo=FALSE}
#copied from https://rpkgs.datanovia.com/ggpubr/reference/ggtexttable.html
ggtexttable(demo_sp_abundance_sim, theme = ttheme("light",
                                                  base_size = 13,
                                                  padding = unit(c(2.5, 4),
                                                                 "mm"))) %>%
  tab_add_title(text = "sp_abundance_sim data frame")


```

2. `sim_dissim` : Calculate relative dissimilarity using `vegdist()` function from `vegan` package

```{r echo=FALSE}
ggtexttable(round(demo_sim_dissim, digits = 3), theme = ttheme("light",
                                            base_size = 8,
                                            padding = unit(c(5, 5),
                                                           "mm"))) %>%
  tab_add_title(text = "sim_abundance data frame")
```

```{r echo=FALSE}
rm(demo_sim_dissim, demo_sp_abundance_sim)
```


### Function used in map_df()

The chunk below contains the function I used in the `map_df()` function. The `map_df()` function is used to generate multiple data frames stacked on top of each other. See code for `map_df()` under section titled "Data frame".

```{r}
#set.seed for consistent randomness since we have a sample_n() function below
set.seed(5)

#create a function to replicate species abundance matrix ONCE
# data frame 'x' to be replaced with 'tree_probs', see next chunk
dissim_func <- function(x) {
  #create a new data frame based on data wrangling on data frame 'x' - which I will replace with tree_probs
  sp_abundance_sim <- as.data.frame(x %>%
  #remove low abundance and random species
  filter(!spp_orig %in% c("LURA","SCHY", "random")) %>%
  #code below tells R to generate 1 random species for every unique treeid, weighted by the column 'est_prob' which is the elevation x  abundance probability
  group_by(treeid) %>%
  sample_n(size = 1, weight = est_prob) %>%
  ungroup() %>% 
  #keep the following columns
  select(treeid, plot, spp_prob) %>%
  #code below counts the number of trees per species per plot per simulation
  group_by(plot, spp_prob) %>% 
  summarise(n_tree = n()) %>%
  #pivot to show species as columns and plot as rows
  pivot_wider(
  names_from = spp_prob, 
  values_from = n_tree,
  values_fill = 0
) %>%
  ungroup() %>%
  select(-plot))
  
#sp_abundance_sim is an species-abundance matrix where  
  
  sim_dissim <- as.data.frame(as.matrix(vegdist(sp_abundance_sim, method = "jaccard"))) 

#name row/col names the same as plot numbers instead of normal running numbers
  #reason: since there are missing plots between 11 and 15
rownames(sim_dissim) <- n_plots$plot
colnames(sim_dissim) <- rownames(sim_dissim)

#subtract data frames: observed - simulated, same as residual formula
dissim_obs - sim_dissim
}
```

### Data frames

I aim to create a large data frame (1200 x 1200) that contains 100 iterations of the `dissim_func`. 

Observed dissimilarity matrix. 
```{r CREATE dissim_obs data frame}
abundance_matrix <-  tree_probs %>% 
  group_by(treeid, plot, spp_orig) %>%
  summarise(n_trees = n()) %>%
  select(-n_trees) %>%
  filter(!spp_orig %in% c("LURA","SCHY", "random")) %>%
  group_by(plot, spp_orig) %>% 
  summarise(n_tree = n()) %>%
  pivot_wider(
  names_from = spp_orig, 
  values_from = n_tree,
  values_fill = 0
) %>%
  ungroup() %>%
  select(-plot)

rownames(abundance_matrix) <- n_plots$plot

#I had to convert it to a matrix first then data frame because it won't allow me to convert it to a dataframe from vegdist() right away. 
dissim_obs <- as.data.frame(as.matrix(vegdist(abundance_matrix, method = "jaccard"))) 

rownames(dissim_obs) <- n_plots$plot
colnames(dissim_obs) <- rownames(dissim_obs)
```

Observed dissimilarity data frame: `dissim_obs`

```{r fig.width = 7.5, fig.height = 4,include = FALSE}
ggtexttable(round(dissim_obs, digits = 3), 
            theme = ttheme("light",
                           base_size = 10.5, 
                           padding = unit(c(5, 4),
                                          "mm"))) %>%
  tab_add_title(text = "dissim_obs data frame")
```


*Create 100 dataframes, stacked on top of one another*

```{r}
#set seed for reproducibility.
set.seed(5)

#use map_df to replicate tree_probs
#add column to id the replicate number of dataframe, .id argument
#data frame contains the difference between the observed and simulation dissimilarity index. The smaller the difference, the better the simulation predicts the observed.
dissim_difference <- map_df(1:100, ~dissim_func(tree_probs), .id = "n_trial")
```

The difference in relative dissimilarity (observed - simulated) is stored in a data frame called `dissim_difference`

Note that the row numbers on the extreme left contain both the running number of rows and the plot numbers that correspond with the `vegdist()` matrix output. 

```{r fig.width = 10, fig.height = 6.5, echo = FALSE}
dissim_difference$n_trial <- as.numeric(dissim_difference$n_trial)

ggtexttable(round(dissim_difference[1:20,], digits = 3), 
            theme = ttheme("light",
                           base_size = 10.5, 
                           padding = unit(c(5, 4),
                                          "mm"))) %>%
  tab_add_title(text = "dissim_difference data frame \n (first 20 rows)")

```



### Median Difference

At this stage we currently have 100 data frames stacked on top of each other in an object called `dissim_difference` Each cell contains the [observed - simulated] `vegdist()` value. I want to reduce the 100 data frames to 1 summary data frame. The summary function I will use is median. The code below gives me one data frame where each value is the median of all the trials.  

I broke down the procedure to 4 steps in order to solve some data wrangling issues, explanations provided. 

 <font size="3"> **Step 1**: Create function + `map_df()` </font>

The `dissim_difference` data frame does not currently have a column to indicate the plot number. I will create this column manually.

To do so, I will use a function which contains the code to make 1 data frame that contains all 12 plot numbers. I will use `map_df()` to create 100 replicates of that data frame. 

```{r}
#create a function that creates a data frame of the plot numbers
n_plot_function <- function(x) {
  plot_num <- c(1:11, 15)
as.data.frame(plot_num)
}

#use mapdf() to create 100 copies of the plot_num dataframe, stacked on top of each other.
plot_rep <- map_df(1:100, ~n_plot_function())



```

`plot_rep`: A data frame which contains running number of plots 1-15 (total of 12 plots), 100 times. (I may have to change this code to ensure that when I change the number of trials, I don't have to change this step)

```{r fig,width = 1, fig.height = 5, echo = FALSE}
ggtexttable(as.data.frame(plot_rep[1:16,]), 
            rows = c(1:16),
            theme = ttheme("light",
                           base_size = 10, 
                           padding = unit(c(50, 3),
                                          "mm"))) %>%
  tab_add_title(text = "plot_rep data frame \n first 16 rows")

# how to make row names appear?

```



<font size="3"> **Step 2**: `cbind()`</font>

I will join the `plot_num` data frame with the `dissim_difference` data frame. 

```{r}
#cbind the 100 copies of the plot numbers into dissim_difference dataframe to id each row by its plot number
dissim_difference <- dissim_difference %>%
  #cbind() grafts the plot numbers to the right of the dissim df
  cbind(plot = plot_rep$plot) %>%
  #code below relocates the plot number columns to the left for readibility
  relocate(plot, .after = n_trial)
```

`dissim_difference` after `cbind` to add plot numbers.

```{r fig.height = 7, fig.width = 10, echo = FALSE}
ggtexttable(round(dissim_difference[1:20,], digits = 3), 
            theme = ttheme("light",
                           base_size = 10.5, 
                           padding = unit(c(5, 4),
                                          "mm"))) %>%
  tab_add_title(text = "dissim_difference data frame \n (first 20 rows)")
```

<font size="3"> **Step 3**: `aggregate`</font>

I now have all pairwise dissimilarity differences in one big data frame (1200 rows). I want to calculate the median difference in dissimilarity for each unique combination of plots. 

I will use the the `aggregate` function to achieve this. 

```{r}
dissim_diff_median <- aggregate(dissim_difference, 
          by = list(dissim_difference$plot),
          FUN = median) %>%
  select(-Group.1, -n_trial)

```

`dissim_diff_median`: Summary data frame of the difference in vegdist() values between observed and simulated populations. (summary function - Median)

```{r echo = FALSE}
ggtexttable(round(dissim_diff_median, digits = 3), 
            rows = NULL,
            theme = ttheme("light",
                           base_size = 10, 
                           padding = unit(c(4, 4),
                                          "mm"))) %>%
  tab_add_title(text = "dissim_diff_median data frame \n (rounded to 3 decimals)")
```


<font size="3"> **Step 4**:  `pivot_longer`</font>

To facilitate plotting the heatmap, I need to convert the wide format df to a long format data frame. In other words, I need to make the columns (currently plot numbers) into a single column titled, "plot"

```{r}
dissim_diff_median <- dissim_diff_median %>%
  #since I will have two columns called plot (x & y axis), I will name each plot_1 and plot_2
  rename(plot_1 = plot) %>%
  pivot_longer(!plot_1, names_to = "plot_2", values_to = "dissim_diff") %>%
  #change plot_2 from 'chr' to 'num'
  mutate(plot_2 = as.numeric(plot_2))

```

`dissim_diff_median` pivtor longer transformation to aid ggplot plotting.

```{r fig.height = 6 ,echo = FALSE}
ggtexttable(round(dissim_diff_median[1:20,], digits = 3), 
            theme = ttheme("light",
                           base_size = 10, 
                           padding = unit(c(10, 3.5),
                                          "mm"))) %>%
  tab_add_title(text = "dissim_diff_median data frame \n (first 20 rows)")
```



### Heatmap (Elev & Abundace)

Heat map shows the difference in vegdist values between the simulated and observed values.

Blue = Low Difference

Orange = Medium Difference

Red = High Difference

The simulation that best represents the observed/real data would be all blue. 

```{r}
#palette code copied from https://www.datanovia.com/en/blog/top-r-color-palettes-to-know-for-great-data-visualization/

pal <- wes_palette("Zissou1", 100, type = "continuous")


dissim_heatmap <- ggplot(dissim_diff_median, 
                         aes(x = factor(plot_1), 
                             y = factor(plot_2), 
                             fill = dissim_diff)) +
  geom_tile() + 
  scale_fill_gradientn(colours = pal) + 
  theme_classic() +
  labs(x = "Plot",
       y = "Plot",
       fill = "Difference in dissimilarity") +
  ggtitle("Difference in dissimilarity between observed and simulated plots \n (Elevation & Abundance)") +
  #all theme adjustments are to change the text size for legibility
  theme(axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        plot.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))
```

```{r fig.height = 10, fig.width = 12}
dissim_heatmap
```


Remove unneccesary objects

```{r}
#remove(plot_rep)
```

Questions:

i.  What does the range of difference 0-0.4 mean? Is it significant?
ii. Why is plot 10 so dissimilar from the other plots? 

## Simulation 2: Abundance Per Plot 

Almost a 1-for-1 repeat of the steps used in "elevation & abundance probability", starting from step 2 -- `cbind`

Run the same loop to compare dissimilarity difference.

See the explanation below this chunk for how Simulation 2 probability is calculated.

```{r}
#didn't annotate much since I redid the same steps, the only changes being the calculation of abundance per plot. 
abund_plot_sp <- inventory %>%
  filter(type == "tree",
         !spp %in% c("LURA", "SCHY", "random")) %>%
  select(plot, spp) %>%
  group_by(plot, spp) %>%
  summarise(tree_per_sp = n()) %>%
  left_join(n_plots) %>%
  mutate(est_prob = tree_per_sp/n_trees) %>%
  ungroup

```

`abund_plot_sp`: `est_prob` is calculated as `tree_per_sp` divded by `n_trees`.

```{r fig.height = 6 ,echo = FALSE}
ggtexttable(abund_plot_sp[1:20,], 
            theme = ttheme("light",
                           base_size = 10, 
                           padding = unit(c(10, 3.5),
                                          "mm"))) %>%
  tab_add_title(text = "abund_plot_sp data frame \n (first 20 rows)")
```


### Data frame

In this section, I will replace the `est_probs` in the `tree_probs` data frame with this new `est_probs` column. I preserved the column name so that the new data frame will run in the `dissim_func` function.

The new data frame will be called `abundance_prob`.

```{r}
abundance_prob <- inventory %>%
  filter(type == "tree",
         !spp %in% c("LURA", "SCHY", "random")) %>%
  select(plot, spp) %>%
  group_by(plot, spp) %>%
  summarise(tree_per_sp = n()) %>%
  left_join(n_plots) %>%
  mutate(abund_prob = tree_per_sp/n_trees) %>%
  select(-tree_per_sp, -n_trees) %>%
  #pivot wider fills up missing species in each plot with a value of zero. 
  #this will be useful when I left join into tree_probs to replace the est_prob column
  pivot_wider(
  names_from = spp, 
  values_from = abund_prob,
  values_fill = 0) %>%
  pivot_longer(!"plot", 
               names_to = "spp_prob",
               values_to = "abund_prob") %>%
  ungroup()

#pipe below essentially left_joins the new probability into the tree_probs data frame. The est_prob is updated with the abundance per plot probability. The rest of the code is just some cleaning.
abund_prob <- tree_probs %>%
  select(-est_prob) %>%
  left_join(abundance_prob) %>%
  rename(est_prob = abund_prob)

rm(abundance_prob)
```

Create 100 data frames, stacked on top of each other with `map_df()`.
```{r}
set.seed(5)

dissim_diff_abund <- map_df(1:100, ~dissim_func(abund_prob), .id = "n_trial")
```

### Median Difference

Here I will repeat the steps from Simulation 1 to get the median summary data frame of difference in `vegdist()` values. 

Step 2: `cbind()` 

I will join the `plot_num` data frame with the `dissim_dissim_diff_abun` data frame. 

```{r}
#cbind the 100 copies of the plot numbers into dissim_difference dataframe to id each row by its plot number
dissim_diff_abund <- dissim_diff_abund %>%
  #cbind() grafts the plot numbers to the right of the dissim df
  cbind(plot = plot_rep$plot) %>%
  #code below relocates the plot number columns to the left for readibility
  relocate(plot, .after = n_trial)
```

Step 3: `aggregate`

I now have all pairwise dissimilarity differences in one big data frame (1200 rows). I want to calculate the median difference in dissimilarity for each unique combination of plots. 

i.e. I want the median value of the difference in dissimilarity between plot 1 and plot 2. 

I will use the the `aggregate` function to achieve this. 

```{r}
dissim_median_abund <- aggregate(dissim_diff_abund, 
          by = list(dissim_diff_abund$plot),
          FUN = median) %>%
  select(-Group.1, -n_trial)
```

Step 4:  `pivot_longer`

To facilitate plotting the heatmap, I need to convert the wide format df to a long format data frame. In other words, I need to make the columns (currently plot numbers) into a single column titled, "plot"

```{r}
dissim_median_abund <- dissim_median_abund %>%
  #since I will have two columns called plot (x & y axis), I will name each plot_1 and plot_2
  rename(plot_1 = plot) %>%
  pivot_longer(!plot_1, names_to = "plot_2", values_to = "dissim_diff") %>%
  #change plot_2 from 'chr' to 'num'
  mutate(plot_2 = as.numeric(plot_2))
```


### Heatmap (abudance-only prob)


```{r}

dissim_heatmap_abund <- ggplot(dissim_median_abund, 
                         aes(x = factor(plot_1), 
                             y = factor(plot_2), 
                             fill = dissim_diff)) +
  geom_tile() + 
  scale_fill_gradientn(colours = pal,
                       limits = range(dissim_diff_median$dissim_diff)) + 
  theme_classic() +
  labs(x = "Plot",
       y = "Plot",
       fill = "Difference in dissimilarity") +
  ggtitle("Difference in dissimilarity between observed and simulated plots \n (Abundance Per Plot Per Sp)") +
  theme(axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        plot.title = element_text(size = 20),
        legend.text = element_text(size = 17),
        legend.title = element_text(size = 20))

range(dissim_diff_median$dissim_diff)
```

```{r fig.height = 10,fig.width = 12}
dissim_heatmap_abund
```


The heatmap is mostly blue which suggests that this simulation is very close to the observed dissimilarity matrix. This is to be expected since I sample weights were taken from the abundance of each plot. When I run it 100 times, I should get a median result that is similar to the observed data.

## Simulation 3: Abundance across all plots

In this simulation, I will change the `est_probs` column of the `tree_probs` data frame yet again. This time I will use the probability taken from the abundance of a species across all plots. 

```{r}
ab_allplot_table <- inventory %>%
  filter(type == "tree",
         !spp %in% c("LURA", "SCHY", "random")) %>%
  select(plot, spp) %>%
  group_by(spp) %>%
  summarise(tree_per_sp = n()) %>%
  mutate(est_prob = tree_per_sp/sum(tree_per_sp)) %>%
  ungroup()
```

`ab_allplot_table`: `est_prob` is calculated from `tree_per_sp` divided by the total number of trees in all plots.

```{r fig.height = 5}
ggtexttable(ab_allplot_table, 
            theme = ttheme("light",
                           base_size = 10, 
                           padding = unit(c(10, 3.5),
                                          "mm"))) %>%
  tab_add_title(text = "ab_allplot_table data frame")

rm(ab_allplot_table)
```

Next I will import this new `est_prob` value in the `tree_probs` data frame and plot the heatmap. I will do all this in one chunk since the process is similar to Simulation 2.

```{r}
#code is a repeat of the dataframe above. 
abund_all_plot <- inventory %>%
  filter(type == "tree",
         !spp %in% c("LURA", "SCHY", "random")) %>%
  select(plot, spp) %>%
  group_by(spp) %>%
  summarise(tree_per_sp = n()) %>%
  mutate(est_prob = tree_per_sp/sum(tree_per_sp)) %>%
  select(-tree_per_sp) %>%
  rename(spp_prob = spp) %>%
  ungroup()

#left_join into tree_probs data frame
abund_prob_all <- tree_probs %>%
  select(-est_prob) %>%
  left_join(abund_all_plot)


rm(abund_all_plot)

set.seed(5)

dissim_diff_abund_2 <- map_df(1:100, ~dissim_func(abund_prob_all), .id = "n_trial")


#add plot column
dissim_diff_abund_2 <- dissim_diff_abund_2 %>%
  #cbind() grafts the plot numbers to the right of the dissim df
  cbind(plot = plot_rep$plot) %>%
  #code below relocates the plot number columns to the left for readibility
  relocate(plot, .after = n_trial)

#aggregate
dissim_median_abund_all <- aggregate(dissim_diff_abund_2, 
          by = list(dissim_diff_abund_2$plot),
          FUN = median) %>%
  select(-Group.1, -n_trial)

#ggplot2 x/y column
dissim_median_abund_all <- dissim_median_abund_all %>%
  #since I will have two columns called plot (x & y axis), I will name each plot_1 and plot_2
  rename(plot_1 = plot) %>%
  pivot_longer(!plot_1, names_to = "plot_2", values_to = "dissim_diff") %>%
  #change plot_2 from 'chr' to 'num'
  mutate(plot_2 = as.numeric(plot_2))

#ggplot2 code
dissim_heatmap_abund_all <- ggplot(dissim_median_abund_all, 
                         aes(x = factor(plot_1), 
                             y = factor(plot_2), 
                             fill = dissim_diff)) +
  geom_tile() + 
  scale_fill_gradientn(colours = pal) + 
  theme_classic() +
  labs(x = "Plot",
       y = "Plot",
       fill = "Difference in dissimilarity") +
  ggtitle("Difference in dissimilarity between observed and simulated plots \n (Abundance Across All Plots)") +
  theme(axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        plot.title = element_text(size = 20),
        legend.text = element_text(size = 17),
        legend.title = element_text(size = 20))

range(dissim_diff_median$dissim_diff)
```

```{r fig.height = 10,fig.width = 12}
dissim_heatmap_abund_all
```


The value of the red/yellow spots are higher in this heat map than the "elevation & abundance" heatmap in simulation 1. This shows that using elevation and abundance better predicts the observed data. (and consequently that this simulation is a worse predictor of the observed data).

### Adjust scales 

of all three heatmaps to make comparison easier.

Give original heatmap same range as the largest median range

```{r}
#put all the range of medians into a dataframe and just max min it
df_name <- c("dissim_diff_median", "dissim_median_abund", "dissim_median_abund_all")

min <- c(min(dissim_diff_median$dissim_diff),
         min(dissim_median_abund$dissim_diff),
         min(dissim_median_abund_all$dissim_diff))

max <- c(max(dissim_diff_median$dissim_diff),
         max(dissim_median_abund$dissim_diff),
         max(dissim_median_abund_all$dissim_diff))

median_range <- data.frame(df_name, min, max)

#reassign heatmaps, add appropriate range
dissim_heatmap <- dissim_heatmap +
 scale_fill_gradientn(colors = pal,
                      #i subset the median_range data frame to ignore the df_name column
                      limits = range(median_range[,2:3]))

dissim_heatmap_abund <- dissim_heatmap_abund +
   scale_fill_gradientn(colors = pal,
                      limits = range(median_range[,2:3]))

dissim_heatmap_abund_all <- dissim_heatmap_abund_all + 
     scale_fill_gradientn(colors = pal,
                      limits = range(median_range[,2:3]))

```

## All three plots at a glance

See pdf file under `nic_mangrove` folder on github for higher resolution image.

```{r fig.width = 60, fig.height = 10}
ggarrange(dissim_heatmap,
                        dissim_heatmap_abund,
                        dissim_heatmap_abund_all,
                        #specify number of rows and columns
                        nrow=1, ncol=3) 
```

## Add original dissimilarity (without subtraction from `dissim_obs`)

### Observed

**Plot `dissim_obs` as heatmap with ggplot2**

```{r}
#use pivot longer on data frame 
obs_df <- dissim_obs %>%
  mutate(plot_1 = c(1:11,15)) %>%
  relocate(plot_1, .before = "1" ) %>%
  pivot_longer(!plot_1, names_to = "plot_2", values_to = "dissim_val") %>%
  mutate(plot_2 = as.numeric(plot_2))

#ggplot2
dissim_heatmap_obs <- ggplot(obs_df, 
                         aes(x = factor(plot_1), 
                             y = factor(plot_2), 
                             fill = dissim_val)) +
  geom_tile() + 
  scale_fill_gradientn(colours = pal) + 
  theme_classic() +
  labs(x = "Plot",
       y = "Plot",
       fill = "Observed Dissimilarity") +
  ggtitle("Observed dissimilarity") +
  #all theme adjustments are to change the text size for legibility
  theme(axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        plot.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))


```
#### Heatmap

```{r fig.height = 10, fig.width = 12}
dissim_heatmap_obs
```


### Simulation 1

**Plot simulated population 1 as heatmap in ggplot2**

Create new function that does not include the subtraction (observed - simulated dissimilarity)

```{r}
set.seed(5)

#create a function to replicate species abundance matrix ONCE
# data frame 'x' to be replaced with 'tree_probs', see next chunk
dissim_func_nosub <- function(x) {
  #create a new data frame based on data wrangling on data frame 'x' - which I will replace with tree_probs
  sp_abundance_sim <- as.data.frame(x %>%
  #remove low abundance and random species
  filter(!spp_orig %in% c("LURA","SCHY", "random")) %>%
  #code below tells R to generate 1 random species for every unique treeid, weighted by the column 'est_prob' which is the elevation x  abundance probability
  group_by(treeid) %>%
  sample_n(size = 1, weight = est_prob) %>%
  ungroup() %>% 
  #keep the following columns
  select(treeid, plot, spp_prob) %>%
  #code below counts the number of trees per species per plot per simulation
  group_by(plot, spp_prob) %>% 
  summarise(n_tree = n()) %>%
  #pivot to show species as columns and plot as rows
  pivot_wider(
  names_from = spp_prob, 
  values_from = n_tree,
  values_fill = 0
) %>%
  ungroup() %>%
  select(-plot))
  
#sp_abundance_sim is an species-abundance matrix where  
  
  sim_dissim <- as.data.frame(as.matrix(vegdist(sp_abundance_sim, method = "jaccard"))) 

#name row/col names the same as plot numbers instead of normal running numbers
  #reason: since there are missing plots between 11 and 15
rownames(sim_dissim) <- n_plots$plot
colnames(sim_dissim) <- rownames(sim_dissim)

sim_dissim <- sim_dissim %>% 
  mutate(plot = c(1:11,15)) %>%
  relocate(plot, .before = "1")

sim_dissim
}
```

Create data frame and plot heatmap in one chunk

test
```{r eval=FALSE, include=FALSE}
#####################TEST############################################
set.seed(5)
  #create a new data frame based on data wrangling on data frame 'x' - which I will replace with tree_probs
  sp_abundance_sim <- as.data.frame(tree_probs %>%
  #remove low abundance and random species
  filter(!spp_orig %in% c("LURA","SCHY", "random")) %>%
  #code below tells R to generate 1 random species for every unique treeid, weighted by the column 'est_prob' which is the elevation x  abundance probability
  group_by(treeid) %>%
  sample_n(size = 1, weight = est_prob) %>%
  ungroup() %>% 
  #keep the following columns
  select(treeid, plot, spp_prob) %>%
  #code below counts the number of trees per species per plot per simulation
  group_by(plot, spp_prob) %>% 
  summarise(n_tree = n()) %>%
  #pivot to show species as columns and plot as rows
  pivot_wider(
  names_from = spp_prob, 
  values_from = n_tree,
  values_fill = 0
) %>%
  ungroup() %>%
  select(-plot))
  
#sp_abundance_sim is an species-abundance matrix where  
  
  sim_dissim <- as.data.frame(as.matrix(vegdist(sp_abundance_sim, method = "jaccard"))) 

#name row/col names the same as plot numbers instead of normal running numbers
  #reason: since there are missing plots between 11 and 15
rownames(sim_dissim) <- n_plots$plot
colnames(sim_dissim) <- rownames(sim_dissim)

sim_dissim <- sim_dissim %>% 
  mutate(plot = c(1:11,15)) %>%
  relocate(plot, .before = "1")

###############TEST#####################################################
```

#### Data frame

```{r}
#100 data frames
dissim_pop_1 <- map_df(1:100, ~dissim_func_nosub(tree_probs), .id = "n_trial")

#median value, matrix form
pop_1_median <- aggregate(dissim_pop_1, 
          by = list(dissim_pop_1$plot),
          FUN = median) %>%
  select(-Group.1, -n_trial)

#median value for plotting
pop_1_median <- pop_1_median %>%
  rename(plot_1 = plot) %>%
  pivot_longer(!plot_1, names_to = "plot_2", values_to = "dissim_val") %>%
  mutate(plot_2 = as.numeric(plot_2))
```


#### Heatmap

```{r fig.height = 10, fig.width  = 12}
##ggplot2 
dissim_heatmap_pop1 <- ggplot(pop_1_median, 
                         aes(x = factor(plot_1), 
                             y = factor(plot_2), 
                             fill = dissim_val)) +
  geom_tile() + 
  scale_fill_gradientn(colours = pal) + 
  theme_classic() +
  labs(x = "Plot",
       y = "Plot",
       fill = "Population 1 \n Dissimilarity") +
  ggtitle("Simulated Population 1 Dissimilarity \n (Elevation & Abundance)") +
  #all theme adjustments are to change the text size for legibility
  theme(axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        plot.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))

dissim_heatmap_pop1
```

### Simulation 3

#### Data frame

```{r}
#100 data frames
dissim_pop_3 <- map_df(1:100, ~dissim_func_nosub(abund_prob_all), .id = "n_trial")

#median value, matrix value
pop_3_median <- aggregate(dissim_pop_3, 
          by = list(dissim_pop_3$plot),
          FUN = median) %>%
  select(-Group.1, -n_trial)

#median value, long format data frame
pop_3_median <- pop_3_median %>%
  rename(plot_1 = plot) %>%
  pivot_longer(!plot_1, names_to = "plot_2", values_to = "dissim_val") %>%
  mutate(plot_2 = as.numeric(plot_2))
```

#### Heatmap

```{r fig.height = 10, fig.width= 12}
##ggplot2 
dissim_heatmap_pop3 <- ggplot(pop_3_median, 
                         aes(x = factor(plot_1), 
                             y = factor(plot_2), 
                             fill = dissim_val)) +
  geom_tile() + 
  scale_fill_gradientn(colours = pal) + 
  theme_classic() +
  labs(x = "Plot",
       y = "Plot",
       fill = "Population 3 \n Dissimilarity") +
  ggtitle("Simluated Population 3 Dissimilarity \n (Abundance Across All Plots)") +
  #all theme adjustments are to change the text size for legibility
  theme(axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        plot.title = element_text(size = 20),
        legend.text = element_text(size = 20),
        legend.title = element_text(size = 20))

dissim_heatmap_pop3
```

### Export original dissim plots (Note: Without scale adjustment)

I did a scale adjustment for the original dissimilarity heatmaps in the next section titled, "Adjust Scales (2nd time)". In that section I placed 5 heat maps together.

1. Observed Dissimilarity     (Obs)

2. Simulation 1 Dissimilarity (S1)

3. Simulation 3 Dissimilarity (S3)

4. Obs - S1 Difference

5. Obs - S3 Difference

```{r eval = FALSE, fig.width = 60, fig.height = 10}
dissim_orig <- ggarrange(dissim_heatmap_obs,
                        dissim_heatmap_pop1,
                        dissim_heatmap_pop3,
                        #specify number of rows and columns
                        nrow=1, ncol=3) 

ggexport(dissim_orig, filename="dissim_orig.pdf", width = 32, height = 8)


```

### Adjust Scales (2nd time)

#### Data frame

Add new rows to `median_range` data frame

```{r}
median_range <- median_range %>% 
  #insert observed dissimilarity range
  add_row(df_name = "dissim_obs",
          min = min(dissim_obs),
          max = max(dissim_obs)) %>%
  #insert pop 1 dissimilarity range 
  add_row(df_name = "dissim_pop_1",
          min = min(pop_1_median$dissim_val),
          max = max(pop_1_median$dissim_val)) %>% 
  add_row(df_name = "dissim_pop_3",
          min = min(pop_3_median$dissim_val),
          max = max(pop_3_median$dissim_val))
  
```

#### Heatmap
Adjust scales within ggplot2 plot code

```{r}
#Difference (Elev & Abundance)
dissim_heatmap <- dissim_heatmap +
 scale_fill_gradientn(colors = pal,
                      limits = range(median_range[,2:3]))

#Difference (Abundance Per Plot)
dissim_heatmap_abund <- dissim_heatmap_abund +
   scale_fill_gradientn(colors = pal,
                      limits = range(median_range[,2:3]))

#Difference (Abundance Across All Plots)
dissim_heatmap_abund_all <- dissim_heatmap_abund_all + 
     scale_fill_gradientn(colors = pal,
                      limits = range(median_range[,2:3]))

#Original   (Observed)
dissim_heatmap_obs <- dissim_heatmap_obs + 
     scale_fill_gradientn(colors = pal,
                      limits = range(median_range[,2:3]))

#Original   (Simulated Pop 1)
dissim_heatmap_pop1 <- dissim_heatmap_pop1 + 
     scale_fill_gradientn(colors = pal,
                      limits = range(median_range[,2:3]))

#Original   (Simluated Pop 3)
dissim_heatmap_pop3 <- dissim_heatmap_pop3 + 
     scale_fill_gradientn(colors = pal,
                      limits = range(median_range[,2:3]))

```


## Export plots 

Export heatmaps side by side

```{r eval=FALSE}
multi.page <- ggarrange(dissim_heatmap,
                        dissim_heatmap_abund,
                        dissim_heatmap_abund_all,
                        #specify number of rows and columns
                        nrow=1, ncol=3) 
multi.page[[1]] 

ggexport(multi.page, filename="dissim_heatmaps_2.pdf", width = 32, height = 8)
```


Export heatmaps (3 Original, 2 difference). Without the (Abundance Per Plot) heatmap 
```{r eval = FALSE}
all_heatmaps <- ggarrange(dissim_heatmap_obs,
                          dissim_heatmap_pop1,
                          dissim_heatmap_pop3,
                          plot_spacer(),
                          dissim_heatmap,
                          dissim_heatmap_abund_all,
                          nrow=2, ncol=3) 

ggexport(all_heatmaps, filename="all_heatmaps.pdf", width = 32, height = 16)
```



## Export data frames 

```{r eval=FALSE}
ggtext_theme <- ttheme(base_size = 20,
                       padding = unit(c(10, 10), "mm"),
             colnames.style = colnames_style(color = "white", fill = "#8cc257"),
             tbody.style = tbody_style(color = "black", fill = c("#e8f3de", "#d3e8bb")))

#^ copied from https://rpkgs.datanovia.com/ggpubr/reference/ggtexttable.html

#do nested layout for second and third heatmaps 


table_text_1 <- ggtexttable(tree_probs[1:10,],theme = ggtext_theme)
table_text_2 <- ggtexttable(abund_plot_sp[1:10,])
table_text_3 <- ggtexttable(abund_prob_all[1:10,])


#add arrow from powerpoint
#arrow <- 
  
#rasterGrob(readPNG("arrow.png"))


```


Export heatmap data frames to use in another project

Note: You'll have to change the data frames to wide format if you want to run it through the NMDS function.

Data frames I will export:

1. `obs_df`

2. `pop_1_median`

3. `pop_3_median`

4. `dissim_diff_median` 

5. `dissim_median_abund_all`

```{r eval = FALSE}
write.csv(obs_df,       'obs_hm.csv')
write.csv(pop_1_median, 'pop1_hm.csv')
write.csv(pop_3_median, 'pop3_hm.csv')
write.csv(dissim_diff_median,    'pop1_diff_hm.csv')
write.csv(dissim_median_abund_all, 'pop3_diff_hm.csv')
```

Export abundace matrix

I might need these for NMDS
```{r}
write.csv(abundance_matrix, 'obs_matrix.csv')
```



## Export plots + data frame

in pdf format

```{r eval=FALSE}

nested_1 <- ggarrange(ggtexttable(tree_probs[1:10,],
                                  theme = ggtext_theme) %>%
                        table_cell_bg(tree_probs[1:10,], row = 1:10, column = 7, fill = "yellow") ,
                      NULL,
                      widths = c(2,1))
nested_2 <- ggarrange(ggtexttable(abund_plot_sp[1:10,],
                                  theme = ggtext_theme),
                      ggtexttable(abund_prob[1:10,], 
                                  theme = ggtext_theme), 
                      nrow = 1,
                      ncol = 2,
                      widths = c(1,5))

nested_3 <- ggarrange(ggtexttable(ab_allplot_table[1:10,],theme = ggtext_theme),
                      ggtexttable(abund_prob_all[1:10,],theme = ggtext_theme),
                      nrow = 1,
                      ncol = 2,
                      widths = c(1,2))

bottom <- ggarrange(nested_1, nested_2, nested_3,
                    nrow = 1)

top <- ggarrange(dissim_heatmap,
                        dissim_heatmap_abund,
                        dissim_heatmap_abund_all,
                 nrow = 1,
                 ncol = 3)
#export 
multi_graphic <- ggarrange(top,
                        bottom,
                        nrow=2,
                        align = "v")

ggexport(multi_graphic, filename="multi_graphic.pdf", width = 40, height = 16)
```


```{r}
rm(abund_plot_sp)
```


